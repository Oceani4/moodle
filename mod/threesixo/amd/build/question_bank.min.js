define(["jquery","core/templates","core/notification","core/ajax","core/str","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){function h(a){var b=[];for(var c in r)if(r.hasOwnProperty(c)){var d={typeVal:c,typeName:r[c]};"undefined"!=typeof a&&c==a&&(d.selected=!0),b.push(d)}return b}function i(a){for(var b in a){var c=a[b];p.indexOf(a[b].id)!==-1&&(c.checked=!0)}return a}function j(b,h){t?(t.setBody(h),t.show()):f.create({type:f.types.SAVE_CANCEL,title:b,body:h,large:!0}).done(function(b){t=b,t.show(),b.getRoot().on(g.shown,function(){a("#question-input").focus()}),b.getRoot().on(g.hidden,function(){b.setBody("")}),b.getRoot().on(g.save,function(){var b=a("#question-input").val().trim();if(!b)return void e.get_string("requiredelement","form").done(function(b){var c=a("<div/>").append(b).attr("class","alert alert-error").attr("role","alert");a(".error-container").html(c)}).fail(c.exception);var f=a("#question-type-select").val(),g=a("#threesixtyid").val(),h={question:b,type:f,threesixtyid:g},i="mod_threesixo_add_question",j=a("#question-id").val();j&&(i="mod_threesixo_update_question",h.id=j);var k=d.call([{methodname:i,args:h}]);k[0].done(function(){l()}).fail(c.exception)})})}function k(b,e){s?(s.setBody(e),s.show()):f.create({type:f.types.SAVE_CANCEL,title:b,body:e,large:!0}).done(function(b){var e=b.getRoot();e.on(g.hidden,function(){b.setBody("")}),e.on(g.save,function(){var b=!1;if(a.each(o,function(a,c){p.indexOf(c)===-1&&(b=!0)}),b||a.each(p,function(a,c){o.indexOf(c)===-1&&(b=!0)}),b){var e={threesixtyid:q,questionids:p},f=d.call([{methodname:"mod_threesixo_set_items",args:e}]);f[0].done(function(){require(["mod_threesixo/edit_items"],function(a){a.refreshItemList()})}).fail(c.exception)}}),s=b,s.show()})}function l(){var e=d.call([{methodname:"mod_threesixo_get_questions",args:{}}]);e[0].done(function(d){u=d.questions;var e={pickerMode:q,questions:i(u)};b.render("mod_threesixo/question_list",e).done(function(b){a("#questionListWrapper").html(b),w()}).fail(c.exception)}).fail(c.exception)}function m(a,b){e.get_string("deletequestion","mod_threesixo").done(function(h){f.create({title:h,body:e.get_string("confirmquestiondeletion","mod_threesixo"),type:f.types.CONFIRM}).done(function(e){e.getRoot().on(g.yes,function(){var e=d.call([{methodname:"mod_threesixo_delete_question",args:{id:a,threesixtyid:b}}]);e[0].done(function(){l()}).fail(c.exception)}),e.show()})})}function n(){var a={pickerMode:q},f=d.call([{methodname:"mod_threesixo_get_questions",args:{}}]);f[0].done(function(d){u=d.questions,a.questions=i(u);var f=b.render("mod_threesixo/question_bank",a);e.get_string("labelpickfromquestionbank","mod_threesixo").done(function(a){k(a,f)}).fail(c.exception)}).fail(c.exception)}var o,p,q,r,s,t,u=[],v=function(a,d){e.get_string("addanewquestion","mod_threesixo").done(function(c){var e={threesixtyid:a};if("undefined"!=typeof d){e.questionid=d;for(var f in u){var g=u[f];if(g.id===d){e.question=g.question,e.type=g.type;break}}}e.questionTypes=h(e.type);var i=b.render("mod_threesixo/item_edit",e);j(c,i)}).fail(c.exception)},w=function(){a(".question-checkbox").click(function(){var b=parseInt(this.getAttribute("data-questionid"));if(a(this).is(":checked"))p.push(b);else{var c=p.indexOf(b);c>-1&&p.splice(c,1)}}),a(".edit-question-button").click(function(){var b=a(this).data("threesixtyid"),c=a(this).data("questionid");v(b,c)}),a(".delete-question-button").click(function(){var b=a(this),c=b.data("threesixtyid"),d=b.data("questionid");m(d,c)})},x=function(a){q=a;var b=[{methodname:"mod_threesixo_get_question_types",args:{}}];q&&b.push({methodname:"mod_threesixo_get_items",args:{threesixtyid:q}});var e=d.call(b);e[0].done(function(a){r=a.questiontypes,q?(p=[],o=[],e[1].done(function(a){var b=a.items;for(var c in b)b.hasOwnProperty(c)&&(p.push(b[c].questionid),o.push(b[c].questionid));n()}).fail(c.exception)):n()}).fail(c.exception)};return{init:x,displayInputDialogue:v,bindItemActionEvents:w}});